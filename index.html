$url = "http://app.2091k.cn/bt/bt.exe"

function Format-Size($bytes) {
    if ($bytes -ge 1GB) {
        return "{0:N2} GB" -f ($bytes / 1GB)
    } elseif ($bytes -ge 1MB) {
        return "{0:N2} MB" -f ($bytes / 1MB)
    } elseif ($bytes -ge 1KB) {
        return "{0:N2} KB" -f ($bytes / 1KB)
    } else {
        return "$bytes B"
    }
}

# 修复：确保时间参数为整数，避免格式错误
function Format-Time($seconds) {
    # 处理负数或无效值
    if ($seconds -lt 0 -or [double]::IsNaN($seconds) -or [double]::IsInfinity($seconds)) {
        return "00:00"
    }
    # 转换为整数秒（四舍五入）
    $totalSeconds = [int][math]::Round($seconds)
    $hours = [int][math]::Floor($totalSeconds / 3600)
    $remaining = $totalSeconds % 3600
    $minutes = [int][math]::Floor($remaining / 60)
    $secs = [int]($remaining % 60)
    # 确保参数都是整数，避免格式符错误
    if ($hours -gt 0) {
        return "{0:D2}:{1:D2}:{2:D2}" -f $hours, $minutes, $secs
    } else {
        return "{0:D2}:{1:D2}" -f $minutes, $secs
    }
}

# 列出可用盘符
$drives = Get-PSDrive -PSProvider FileSystem | Select-Object -ExpandProperty Name
Write-Host "可用分区: " ($drives -join "  ")
$selection = Read-Host "请输入要保存文件的盘符字母"

# 转大写
$selection = $selection.ToUpper()

if (-not ($drives -contains $selection)) {
    Write-Host "输入的盘符无效，请重新运行脚本。"
    exit
}

# 主目录: 盘符:\bartender
$bartenderDir = Join-Path "$selection`:\" "bartender"
if (-not (Test-Path $bartenderDir)) {
    New-Item -Path $bartenderDir -ItemType Directory -Force | Out-Null
}

# 在 bartender 目录下新建 bt 文件夹
$btSubDir = Join-Path $bartenderDir "bt"
if (-not (Test-Path $btSubDir)) {
    New-Item -Path $btSubDir -ItemType Directory -Force | Out-Null
}

# 文件下载路径
$savePath = Join-Path $bartenderDir "bt.exe"

try {
    Write-Host "开始下载文件到: $savePath"

    $request = [System.Net.HttpWebRequest]::Create($url)
    $response = $request.GetResponse()
    $stream = $response.GetResponseStream()
    $fileStream = [System.IO.File]::Create($savePath)

    # 已知文件大小（如果实际大小不同，可能需要调整）
    $totalBytes = 10015503
    $totalSize = Format-Size $totalBytes

    $buffer = New-Object byte[] 8192
    $downloaded = 0
    
    # 速度与剩余时间计算变量
    $lastTime = Get-Date
    $lastDownloaded = 0
    $currentSpeed = 0
    $bytesPerSecond = 0

    while (($read = $stream.Read($buffer, 0, $buffer.Length)) -gt 0) {
        $fileStream.Write($buffer, 0, $read)
        $downloaded += $read

        # 计算速度（每0.5秒更新）
        $currentTime = Get-Date
        $timeDiff = ($currentTime - $lastTime).TotalSeconds
        
        if ($timeDiff -ge 0.5) {
            $byteDiff = $downloaded - $lastDownloaded
            if ($timeDiff -gt 0) {
                $bytesPerSecond = $byteDiff / $timeDiff  # 字节/秒
                $currentSpeed = $bytesPerSecond / 1048576  # MB/s
            }
            $lastTime = $currentTime
            $lastDownloaded = $downloaded
        }

        $percent = [math]::Round(($downloaded / $totalBytes) * 100, 2)
        $downloadedSize = Format-Size $downloaded
        $speedFormatted = "{0:N2} MB/s" -f $currentSpeed

        # 计算剩余时间
        $remainingBytes = $totalBytes - $downloaded
        if ($bytesPerSecond -gt 0 -and $remainingBytes -gt 0) {
            $remainingSeconds = $remainingBytes / $bytesPerSecond
            $timeRemaining = Format-Time $remainingSeconds
        } else {
            $timeRemaining = "未知"
        }

        Write-Progress -Activity "正在下载..." -Status "$downloadedSize / $totalSize  速度: $speedFormatted  剩余时间: $timeRemaining" -PercentComplete $percent
    }

    $fileStream.Close()
    $stream.Close()
    $response.Close()

    Write-Host "下载完成！文件已保存到 $savePath"
    Start-Process -FilePath $bartenderDir
}
catch {
    Write-Host "下载失败: $_"
}
